Factories live under `database/factories/` in Laravel, each returning arrays that seed model attributes via Faker. You call them through `Model::factory()` in seeds/tests; they can define default states, relationships, and named variants (e.g., `->state()` or `->has()` helpers). This doc lists the factory contracts weâ€™ll implement before coding them, mirroring the domain described in `7. Models.md`.

---

# Factory Overview

## 1. Organization & Tenancy

### OrganizationFactory
```php
class OrganizationFactory extends Factory {
    protected $model = Organization::class;

    public function definition(): array {
        return [
            'name' => $this->faker->company(),
            'slug' => Str::slug($name).uniqid('-'),
            'plan_tier' => PlanTier::FREE,
            'feature_manifest' => [],
            'domain' => null,
            'owner_user_id' => User::factory(),
            'settings' => [],
        ];
    }

    public function pro(): self;   // plan_tier = PRO
    public function enterprise(): self; // plan_tier = ENTERPRISE
}
```

### OrganizationMembershipFactory
```php
class OrganizationMembershipFactory extends Factory {
    protected $model = OrganizationMembership::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'user_id' => User::factory(),
            'role' => $this->faker->randomElement(OrgRole::cases()),
            'status' => MembershipStatus::ACTIVE,
            'invited_by' => null,
            'invited_at' => null,
            'accepted_at' => now(),
        ];
    }

    public function invited(): self;  // status = INVITED, accepted_at null
    public function owner(): self;    // role = OWNER
}
```

### FeatureFlagFactory
```php
class FeatureFlagFactory extends Factory {
    protected $model = FeatureFlag::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'feature_key' => $this->faker->unique()->word(),
            'enabled_at' => now(),
            'expires_at' => null,
            'meta' => [],
        ];
    }

    public function trial(int $days = 14): self; // expires_at = now() + days
}
```

### AuditLogFactory
```php
class AuditLogFactory extends Factory {
    protected $model = AuditLog::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'user_id' => User::factory(),
            'actor_type' => ActorType::USER,
            'actor_id' => fn(array $attrs) => $attrs['user_id'],
            'event' => AuditEvent::CREATED,
            'entity_type' => CaseFile::class,
            'entity_id' => fn() => CaseFile::factory(),
            'diff' => ['before' => [], 'after' => []],
            'ip' => $this->faker->ipv4(),
            'user_agent' => $this->faker->userAgent(),
            'created_at' => now(),
        ];
    }
}
```

---

## 2. Whistleblowing Intake

### ChannelFactory
```php
class ChannelFactory extends Factory {
    protected $model = Channel::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'name' => $this->faker->words(3, true),
            'slug' => Str::slug($name).uniqid('-'),
            'status' => ChannelStatus::ACTIVE,
            'intake_settings' => ['captcha' => true],
            'public_key' => FakeCrypto::publicKey(),
        ];
    }

    public function archived(): self; // status = ARCHIVED
}
```

### ReportFactory
```php
class ReportFactory extends Factory {
    protected $model = Report::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'channel_id' => Channel::factory(),
            'status' => ReportStatus::NEW,
            'ciphertext' => FakeCrypto::encryptedPayload(),
            'metadata' => ['locale' => $this->faker->languageCode()],
            'created_via' => IngestChannel::WEB,
            'reference_code' => strtoupper(Str::random(10)),
            'received_at' => now(),
            'acknowledged_at' => null,
        ];
    }

    public function acknowledged(): self; // sets acknowledged_at, status TRIAGED
}
```

---

## 3. Case Management

### CaseFileFactory
```php
class CaseFileFactory extends Factory {
    protected $model = CaseFile::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'report_id' => Report::factory(),
            'assignee_user_id' => User::factory(),
            'status' => CaseStatus::NEW,
            'priority' => CasePriority::MEDIUM,
            'due_at' => now()->addDays(14),
            'tags' => [],
            'properties' => [],
        ];
    }

    public function withMessages(int $count = 3): self; // ->has(CaseMessage::factory()->count($count))
    public function unresolved(): self; // status IN_PROGRESS
    public function resolved(): self;   // status RESOLVED, due_at null
}
```

### CaseMessageFactory
```php
class CaseMessageFactory extends Factory {
    protected $model = CaseMessage::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'case_id' => CaseFile::factory(),
            'sender_type' => SenderType::AGENT,
            'sender_user_id' => User::factory(),
            'ciphertext' => FakeCrypto::encryptedMessage(),
            'attachments' => [],
            'sent_at' => now(),
        ];
    }

    public function reporter(): self; // sender_type REPORTER, sender_user_id null
}
```

### AttachmentFactory
```php
class AttachmentFactory extends Factory {
    protected $model = Attachment::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'attachable_type' => CaseMessage::class,
            'attachable_id' => fn() => CaseMessage::factory(),
            'disk' => 's3',
            'path' => 'attachments/'.Str::uuid().'.bin',
            'original_name' => $this->faker->word().'.pdf',
            'mime' => 'application/pdf',
            'size' => $this->faker->numberBetween(10_000, 500_000),
            'checksum' => Str::random(64),
            'encrypted_meta' => ['iv' => Str::random(24)],
        ];
    }
}
```

### CaseEventFactory
```php
class CaseEventFactory extends Factory {
    protected $model = CaseEvent::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'case_id' => CaseFile::factory(),
            'event' => CaseEventType::STATUS_CHANGED,
            'actor_user_id' => User::factory(),
            'data' => ['from' => CaseStatus::NEW, 'to' => CaseStatus::TRIAGE],
            'created_at' => now(),
        ];
    }
}
```

---

## 4. Deadlines & Compliance

### DeadlineFactory
```php
class DeadlineFactory extends Factory {
    protected $model = Deadline::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'case_id' => CaseFile::factory(),
            'type' => DeadlineType::ACK,
            'status' => DeadlineStatus::OPEN,
            'due_at' => now()->addDays(7),
            'met_at' => null,
            'metadata' => [],
        ];
    }

    public function met(): self;      // status MET, met_at = now()
    public function breached(): self; // status BREACHED, due_at in past
}
```

### BreachLogFactory
```php
class BreachLogFactory extends Factory {
    protected $model = BreachLog::class;

    public function definition(): array {
        return [
            'organization_id' => Organization::factory(),
            'case_id' => CaseFile::factory(),
            'detected_at' => now()->subHours(3),
            'notified_at' => null,
            'authority_notified' => false,
            'description' => $this->faker->sentence(),
            'impact' => ['records' => $this->faker->numberBetween(5, 50)],
            'remediation' => ['actions' => ['rotate_keys', 'notify_team']],
            'created_by' => User::factory(),
        ];
    }

    public function notified(): self; // notified_at = now(), authority_notified = true
}
```

### ReporterPortalTokenFactory
```php
class ReporterPortalTokenFactory extends Factory {
    protected $model = ReporterPortalToken::class;

    public function definition(): array {
        $selector = Str::random(20);
        $verifier = Str::random(40);

        return [
            'organization_id' => Organization::factory(),
            'case_id' => CaseFile::factory(),
            'selector' => $selector,
            'verifier_hash' => hash('sha256', $verifier),
            'last_seen_at' => now(),
            'expires_at' => now()->addMonths(6),
            'revoked_at' => null,
        ];
    }

    public function expired(): self; // expires_at in past
    public function revoked(): self; // revoked_at = now()
}
```

---

## 5. Seeder Outline

```
DatabaseSeeder:
  users = User::factory()->count(10)->create()
  orgs = Organization::factory()
      ->count(3)
      ->has(
          OrganizationMembership::factory()
              ->state(fn (array $attrs, Organization $org) => ['organization_id' => $org->id])
              ->count(4)
      )
      ->create()

  orgs->each(function ($org) {
      FeatureFlag::factory()->count(2)->create(['organization_id' => $org->id]);

      Channel::factory()
          ->count(2)
          ->for($org)
          ->has(
              Report::factory()
                  ->count(5)
                  ->has(
                      CaseFile::factory()
                          ->state(['organization_id' => $org->id])
                          ->has(CaseMessage::factory()->count(3))
                          ->has(Deadline::factory()->count(4))
                          ->has(ReporterPortalToken::factory()->count(1)),
                      'caseFile'
                  )
          )
          ->create();
  });

  BreachLog::factory()->count(3)->create();
```

This structure ensures every organization gets memberships, feature flags, channels, reports, cases, messages, deadlines, and reporter portal tokens with consistent organization scoping.
