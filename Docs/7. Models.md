# Models Overview

This document captures the domain models we intend to generate in Laravel. It blends precise column definitions with illustrative snippets so we can validate relationships before scaffolding migrations. All identifiers assume **soft multi-tenancy** (`organization_id` foreign key) unless otherwise noted.

---

## Legend & Conventions

* `uuid` ⇒ ULID/UUID strings stored as `char(36)` (Laravel `->uuid()` helper).
* `enum(Status|Priority)` ⇒ backed enums, defined under `App\Enums`.
* `json` ⇒ `jsonb` in PostgreSQL with cast to array/object in Eloquent.
* Relationship notation:
  * `Organization 1 --- * Channel` ⇒ one-to-many.
  * `User * --- * Organization` ⇒ many-to-many via pivot.
* Sample class blocks show intended methods and casts; some traits (`HasUuid`, `ScopedByOrganization`) are pseudo-code placeholders we will implement.

---

## Core Platform & Tenancy

```
Organization 1 --- * OrganizationMembership * --- 1 User
Organization 1 --- * FeatureFlag
Organization 1 --- * AuditLog
Organization 1 --- * Channel
```

### Organization
**Business Logic & Responsibilities**
* Encapsulates tenant configuration; owns members, channels, and cases.
* Publishes feature manifest so UI/API can gate functionality per plan tier.
* Serves as primary scoping key for authorization and auditing.

**Traits, Protection & Libraries**
* Uses `HasUuid` for UUID keys (custom trait planned).
* Stores dynamic `feature_manifest`/`settings` JSON that should be mutated via dedicated services.
* `owner()` relation links to `User` responsible for billing and critical actions.

```
columns:
  id uuid pk
  name string
  slug string unique
  plan_tier enum(PlanTier)
  feature_manifest json default {}
  domain string nullable
  owner_user_id uuid fk -> users
  settings json default {}
  created_at, updated_at

class Organization extends Model {
    use HasUuid;

    protected $casts = [
        'feature_manifest' => 'array',
        'settings' => 'array',
        'plan_tier' => PlanTier::class,
    ];

    public function owner(): BelongsTo;
    public function memberships(): HasMany;
    public function users(): BelongsToMany; // via memberships
    public function featureFlags(): HasMany;
    public function auditLogs(): HasMany;
}
```

### User
**Business Logic & Responsibilities**
* Authenticates via Laravel Fortify; participates in multiple organizations.
* Manages two-factor secrets, notification routing, and invitation acceptance.
* Provides helpers for active organization context and derived permissions (future).

**Traits, Protection & Libraries**
* Extends `Illuminate\Foundation\Auth\User` (`Authenticatable`).
* Current implementation uses `HasFactory`, `Notifiable`, `TwoFactorAuthenticatable`.
* `fillable`: `name`, `email`, `password` to permit profile updates while guarding other attributes.
* `hidden`: `password`, `two_factor_secret`, `two_factor_recovery_codes`, `remember_token` — prevents secrets from leaking when serializing. (Code currently lists `two_factory_recovery_codes`; fix typo when updating.)
* Casts `email_verified_at` (`datetime`) and `password` (`hashed`).

```
columns:
  id uuid pk
  name string
  email string unique
  password string
  locale string default 'en'
  last_login_at timestamp nullable
  remember_token string nullable
  created_at, updated_at

class User extends Authenticatable {
    use HasUuid, HasApiTokens, Notifiable;

    public function memberships(): HasMany;
    public function organizations(): BelongsToMany;
    public function currentOrganization(): BelongsToMany (scoped by session context);
}
```

### OrganizationMembership (`organization_user`)
**Business Logic & Responsibilities**
* Connects users to organizations with role and status metadata.
* Drives authorization checks (owner/admin/manager/agent/viewer).
* Tracks invitation lifecycle (`invited` → `active` → `disabled`), enabling audits.

**Traits, Protection & Libraries**
* Extends Eloquent `Pivot`; applies `ScopedByOrganization` trait to enforce tenancy.
* Enum casts (`OrgRole`, `MembershipStatus`) keep comparisons strict.
* Generally guarded; update via dedicated service layer to avoid mass assignment issues.

```
columns:
  organization_id uuid fk cascade
  user_id uuid fk cascade
  role enum(OrgRole) // owner, admin, manager, agent, viewer
  status enum(MembershipStatus) // active, invited, disabled
  invited_by uuid fk -> users nullable
  invited_at timestamp nullable
  accepted_at timestamp nullable
  created_at, updated_at
  unique (organization_id, user_id)

class OrganizationMembership extends Pivot {
    use ScopedByOrganization;

    protected $casts = [
        'role' => OrgRole::class,
        'status' => MembershipStatus::class,
    ];
}
```

### Role & Permission (via `spatie/laravel-permission`)
* Keep package tables (`roles`, `permissions`, pivots) tenant-neutral.
* Apply `organization_id` column if we need per-org custom roles later; MVP can reuse shared definitions.

### FeatureFlag
**Business Logic & Responsibilities**
* Toggles modules per organization (e.g., Risk, Reporter Portal trials).
* Evaluated by middleware/UI to permit or block functionality.
* Supports optional metadata (trial expiry notes, reason codes).

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`.
* Unique `(organization_id, feature_key)` prevents duplicate toggles.
* JSON `meta` should be mutated through value objects to avoid schema drift.

```
columns:
  id uuid pk
  organization_id uuid fk
  feature_key string
  enabled_at timestamp
  expires_at timestamp nullable
  meta json default {}
  created_at, updated_at
  unique (organization_id, feature_key)

class FeatureFlag extends Model {
    use ScopedByOrganization;

    protected $casts = ['meta' => 'array'];
}
```

### AuditLog
**Business Logic & Responsibilities**
* Records immutable audit trail entries for compliance (who/what/when).
* Stores diff snapshots, actor metadata, and supports export/reporting.
* Supplements `CaseEvent` by covering non-case resources too.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuids`.
* Actor relationship may morph to `User` or system service account.
* Sanitize diffs prior to save to avoid plaintext leakage.

```
columns:
  id uuid pk
  organization_id uuid fk
  user_id uuid nullable fk
  actor_type enum(ActorType) // user, system, api, reporter
  event enum(AuditEvent) // created, updated, deleted, status_changed...
  entity_type string morph
  entity_id uuid
  diff json default {}
  ip string nullable
  user_agent string nullable
  created_at

class AuditLog extends Model {
    use ScopedByOrganization, HasUuids;

    protected $casts = ['diff' => 'array', 'actor_type' => ActorType::class];

    public function actor(): MorphTo?; // user or system
}
```

---

## Whistleblowing Intake

```
Organization 1 --- * Channel 1 --- * Report 1 --- 1 Case
Report 1 --- * Attachment
Case 1 --- * CaseMessage 1 --- * Attachment
Case 1 --- * CaseEvent
```

### Channel
**Business Logic & Responsibilities**
* Represents a public intake endpoint (slug-based) with encryption parameters.
* Controls reporter experience (languages, captcha, form schema).
* Only active channels accept reports; archived ones remain for history.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuid`.
* `intake_settings` JSON should be validated against schema to avoid unsafe configs.

```
columns:
  id uuid pk
  organization_id uuid fk
  name string
  slug string unique per org
  status enum(ChannelStatus) // active, archived
  intake_settings json default {} // captcha, languages, form config
  public_key text // PEM/JWK
  created_at, updated_at

class Channel extends Model {
    use ScopedByOrganization, HasUuid;

    protected $casts = [
        'intake_settings' => 'array',
        'status' => ChannelStatus::class,
    ];

    public function reports(): HasMany;
}
```

### Report
**Business Logic & Responsibilities**
* Stores encrypted submissions and metadata needed for routing.
* Generates `reference_code` for reporter follow-up and triggers case workflow.
* Tracks `acknowledged_at` to satisfy regulatory reporting.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuid`.
* `ciphertext` JSON remains encrypted; controllers must never log or expose plaintext.
* Attachment relationship ensures file metadata inherits org scope.

```
columns:
  id uuid pk
  organization_id uuid fk
  channel_id uuid fk
  status enum(ReportStatus) // new, triaged, rejected (internal use)
  ciphertext json // encrypted payload
  metadata json default {} // size, reporter hints, contact opt-in
  created_via enum(IngestChannel) // web, email, import, api
  reference_code string unique
  received_at timestamp
  acknowledged_at timestamp nullable
  created_at, updated_at

class Report extends Model {
    use ScopedByOrganization, HasUuid;

    protected $casts = [
        'ciphertext' => 'array',
        'metadata' => 'array',
        'status' => ReportStatus::class,
        'created_via' => IngestChannel::class,
    ];

    public function channel(): BelongsTo;
    public function case(): HasOne;
    public function attachments(): MorphMany; // via Attachments morph
}
```

### Case
**Business Logic & Responsibilities**
* Central work object for agents: tracks status, priority, assignments, due dates.
* Enforces state transitions (e.g., cannot resolve without assignee) via policies/services.
* Aggregates related data: messages, deadlines, events, attachments.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuid`.
* Enum casts for `status`/`priority` to restrict values.
* `tags` / `properties` arrays allow optional customization while staying schemaless.

```
columns:
  id uuid pk
  organization_id uuid fk
  report_id uuid fk unique
  assignee_user_id uuid fk nullable
  status enum(CaseStatus) // new, triage, in_progress, resolved, closed
  priority enum(CasePriority) // low, medium, high
  due_at timestamp nullable
  tags json default []
  properties json default {}
  created_at, updated_at

class CaseFile extends Model { // actual name: Case
    use ScopedByOrganization, HasUuid;

    protected $casts = [
        'status' => CaseStatus::class,
        'priority' => CasePriority::class,
        'tags' => 'array',
        'properties' => 'array',
    ];

    public function report(): BelongsTo;
    public function assignee(): BelongsTo(User::class, 'assignee_user_id');
    public function messages(): HasMany;
    public function events(): HasMany;
    public function attachments(): MorphMany;
    public function deadlines(): HasMany;
}
```

### CaseMessage
**Business Logic & Responsibilities**
* Holds encrypted text exchanges between reporter and agents.
* Drives notifications (metadata only) and read/unread tracking (future).
* Supports attachments associated per message.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuid`.
* `ciphertext` and attachment references are JSON; service layer must validate size/type.
* Sender context indicates reporter (anonymous) vs agent (user).

```
columns:
  id uuid pk
  organization_id uuid fk
  case_id uuid fk
  sender_type enum(SenderType) // agent, reporter, system
  sender_user_id uuid nullable fk -> users
  ciphertext json // encrypted text + keys
  attachments json default [] // references to Attachment ids
  sent_at timestamp
  created_at, updated_at

class CaseMessage extends Model {
    use ScopedByOrganization, HasUuid;

    protected $casts = [
        'ciphertext' => 'array',
        'attachments' => 'array',
        'sender_type' => SenderType::class,
    ];

    public function case(): BelongsTo;
    public function attachments(): BelongsToMany(Attachment::class) // pivot table? or json reference
}
```

### Attachment
**Business Logic & Responsibilities**
* Stores metadata for encrypted files in object storage.
* Supports polymorphic relation to reports/messages, enabling reuse.
* Checksums enable tamper detection; `encrypted_meta` can store IVs/hashes.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuid`.
* Consider hooking into Laravel filesystem for signed URL generation and access logging.

```
columns:
  id uuid pk
  organization_id uuid fk
  attachable_type string morph
  attachable_id uuid
  disk string default 's3'
  path string
  original_name string
  mime string
  size integer
  checksum string
  encrypted_meta json default {}
  created_at, updated_at

class Attachment extends Model {
    use ScopedByOrganization, HasUuid, InteractsWithMedia; // pseudo trait

    protected $casts = ['encrypted_meta' => 'array'];

    public function attachable(): MorphTo;
}
```

### CaseEvent
**Business Logic & Responsibilities**
* Provides chronological timeline for case actions (status change, deadline breach, assignment).
* Used in UI timelines and compliance exports.
* Complements `AuditLog` with case-specific narratives.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuid`.
* `data` JSON sanitized before display to avoid leaking encrypted content.

```
columns:
  id uuid pk
  organization_id uuid fk
  case_id uuid fk
  event enum(CaseEventType) // status_changed, assigned, message_sent, deadline_breached...
  actor_user_id uuid nullable fk
  data json default {}
  created_at

class CaseEvent extends Model {
    use ScopedByOrganization, HasUuid;

    protected $casts = [
        'event' => CaseEventType::class,
        'data' => 'array',
    ];
}
```

---

## SLA & Compliance

```
Case 1 --- * Deadline
Organization 1 --- * BreachLog
```

### Deadline
**Business Logic & Responsibilities**
* Tracks SLA checkpoints (acknowledgement, triage, assignment, feedback).
* Scheduler updates status (`open` → `met`/`breached`) and triggers notifications.
* Supports dashboard metrics and compliance exports.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuid`.
* Enum casts enforce valid deadline types/statuses.
* `metadata` JSON can capture reason for breach or manual overrides.

```
columns:
  id uuid pk
  organization_id uuid fk
  case_id uuid fk
  type enum(DeadlineType) // ack, triage, assign, feedback
  due_at timestamp
  met_at timestamp nullable
  status enum(DeadlineStatus) // open, met, breached
  metadata json default {}
  created_at, updated_at

class Deadline extends Model {
    use ScopedByOrganization, HasUuid;

    protected $casts = [
        'type' => DeadlineType::class,
        'status' => DeadlineStatus::class,
        'metadata' => 'array',
    ];

    public function case(): BelongsTo;
}
```

### BreachLog
**Business Logic & Responsibilities**
* Records security/privacy incidents for GDPR Article 33 evidence.
* Tracks timelines (detection, notification) and impact/remediation details.
* Links to cases when whistleblower reports surface incidents.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuid`.
* `impact` / `remediation` JSON should follow structured schema for reporting.

```
columns:
  id uuid pk
  organization_id uuid fk
  case_id uuid nullable fk
  detected_at timestamp
  notified_at timestamp nullable
  authority_notified boolean default false
  description text
  impact json default {}
  remediation json default {}
  created_by uuid fk -> users
  created_at, updated_at

class BreachLog extends Model {
    use ScopedByOrganization, HasUuid;

    protected $casts = [
        'impact' => 'array',
        'remediation' => 'array',
    ];

    public function case(): BelongsTo;
    public function author(): BelongsTo(User::class, 'created_by');
}
```

---

## Reporter Portal

```
Case 1 --- * ReporterPortalToken
```

### ReporterPortalToken
**Business Logic & Responsibilities**
* Grants reporters secure follow-up access with sliding expiration window.
* Supports revocation/extension by agents; logs actions for audit.
* Powers anonymous messaging while keeping server blind to plaintext.

**Traits, Protection & Libraries**
* Uses `ScopedByOrganization`, `HasUuid`.
* Stores hashed verifier portion only; selector remains safe for lookup.
* `scopeActive` helper filters valid tokens for middleware.

```
columns:
  id uuid pk
  organization_id uuid fk
  case_id uuid fk
  selector string unique // public portion
  verifier_hash string // hashed secret portion
  last_seen_at timestamp nullable
  expires_at timestamp
  revoked_at timestamp nullable
  created_at, updated_at

class ReporterPortalToken extends Model {
    use ScopedByOrganization, HasUuid;

    protected $dates = ['last_seen_at', 'expires_at', 'revoked_at'];

    public function case(): BelongsTo;

    public function scopeActive($query) {
        return $query->whereNull('revoked_at')
                     ->where('expires_at', '>', now());
    }
}
```

---

## Supporting Models

### OrganizationSetting (optional enrichment)
* Encapsulates individual settings beyond the main JSON blob; helpful when auditing changes.
* Use when settings require history or validation independent of base `Organization`.

If settings grow beyond a single `settings` JSON column, introduce a dedicated model:
```
columns:
  id uuid pk
  organization_id uuid fk
  key string
  value json
  created_at, updated_at

unique (organization_id, key)
```

### SystemNotification / Digest (stretch)
* Stores pending metadata-only notifications that can be batched into daily/weekly digests.
* Defer implementation until EP-SLA-003; likely simple model with JSON payload and status flags.

---

## Next Steps

1. Confirm enum sets (`PlanTier`, `OrgRole`, `CaseStatus`, etc.) and record canonical values in a shared `Enums.md` or PHP enum definitions.
2. Decide whether `attachments` should remain polymorphic (current plan) or use dedicated pivot tables per use-case.
3. Validate retention/business rules (e.g., cascading deletes) before writing migrations.
4. Once approved, generate migrations/models in batches aligned with epics (start with EP-CORE-PLATFORM).
