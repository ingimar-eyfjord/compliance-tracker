# Process Mapping & Business Logic

The diagrams below summarize how the major models interact, what triggers create downstream effects, and which business rules apply. Each Mermaid graph captures a core domain slice so you can visualize the flow when reading controllers or designing new features.

---

## 1. Organization & Tenancy

```mermaid
flowchart TD
    subgraph Tenant Scope
        Org[Organization] -->|has many| Memberships[OrganizationMembership]
        Memberships -->|belongs to| User
        Org -->|has many| FeatureFlags
        Org -->|has many| Channels
        Org -->|has many| Cases
        Org -->|has many| Reports
        Org -->|has many| BreachLogs
        Org -->|recorded in| AuditLogs
    end

    style Org fill:#1f2937,stroke:#fff,color:#fff
    style Memberships fill:#0f766e,stroke:#fff,color:#fff
    style User fill:#0f172a,stroke:#fff,color:#fff
    style FeatureFlags fill:#0f766e,stroke:#fff,color:#fff
```

**Business Notes**
- Membership roles (`OrgRole`) gate access; middleware loads `tenant` + membership.
- Feature flags combine persisted toggles with manifest JSON per organization.
- Every tenant-specific model must include `organization_id` and preferably use `ScopedByOrganization`.

---

## 2. Channel → Report → Case Flow

```mermaid
flowchart TD
    Channel -.settings/.-> Report
    Report -->|creates| Case
    Case -->|generates| Deadlines
    Case -->|logs actions via| CaseEvents
    Case -->|messages & files| CaseMessages
    CaseMessages --> Attachments
    Case -->|portal token| ReporterPortalToken
```

**Business Notes**
- When a report is submitted, controllers encrypt payloads client-side; server stores ciphertext only.
- A new case is created for each report (1:1 now, but future merges/splits possible).
- Deadlines (ACK/TRIAGE/ASSIGN/FEEDBACK) created automatically; scheduler updates status and triggers notifications.
- Case events and audit logs track history; both must exclude sensitive ciphertext.

---

## 3. Case Detail Messaging & Attachments

```mermaid
flowchart LR
    Case --> CaseMessages
    CaseMessages -->|has many| Attachments
    Case -->|appears in| AuditLogs
    Case --> Assignee[User]
    Case --> ReporterPortalToken
```

**Business Notes**
- Messages have `sender_type` (agent/reporter/system). Reporter messages still encrypted end-to-end.
- Attachments are stored in S3-compatible storage; metadata includes checksum and encrypted meta info.
- Audit logs capture status changes, assignment updates, portal actions.
- Portal tokens allow reporters anonymous follow-up; tokens expire or can be revoked by agents.

---

## 4. Compliance & Breach Management

```mermaid
flowchart TD
    Case -->|evidence| BreachLog
    BreachLog -->|metrics for| ComplianceOverview[Compliance Dashboard]
    Deadline -->|aggregated counts| ComplianceOverview
    AuditLogs -->|export| ComplianceOverview
```

**Business Notes**
- Breach logs record incidents (GDPR Art.33); can link back to cases as evidence.
- Compliance overview aggregates open cases, breach counts, deadline status, and latest audit entries.
- Feature flag `compliance` guards access to breach and audit screens.

---

## 5. Settings & Administration

```mermaid
flowchart LR
    Org -->|owner controls| OrgSettings
    OrgSettings -->|lists| Memberships
    OrgSettings --> FeatureFlags
    OrgSettings --> AuditLogs
    User --> TwoFactorSettings
```

**Business Notes**
- Member management: owners/admins can invite users, change roles, disable access.
- Feature toggles combine JSON manifest + DB flags; owners can enable trials or view expiring features.
- Audit log page provides filters/export for regulators.
- Profile and 2FA settings rely on Fortify; permission checks ensure users confirm password before enabling 2FA.

---

## 6. Notification & SLA Processes

```mermaid
sequenceDiagram
    participant Reporter
    participant Frontend
    participant Backend
    participant Queue

    Reporter->>Frontend: Submit encrypted report
    Frontend->>Backend: POST /channels/{slug}/reports
    Backend->>Backend: Store Report + Case
    Backend->>Queue: dispatch CreateDeadlines job
    Queue->>Backend: insert Deadlines (ACK/TRIAGE/ASSIGN/FEEDBACK)
    Backend->>AuditLogs: log "case_created"
    Backend->>Frontend: redirect to confirmation (reference code)
```

**Business Notes**
- Queue ensures SLA deadlines and notifications run asynchronously.
- Audit logging centralizes state changes; controllers use `AuditLogger::log` after mutations.
- When deadlines near breach, scheduled jobs send notifications (email/web) without exposing ciphertext.

---

## Using These Diagrams

1. **Trace flow** when adding features: e.g., to add SMS notifications, extend the Deadline branch in the notification sequence.
2. **Check relationships** before writing queries—each arrow hints at required eager loads.
3. **Consult business rules** (notes under each diagram) to ensure new code respects encryption, auditing, and multi-tenancy constraints.
