This doc captures the functional requirements for the MVP described in the previous docs. It groups behaviour by domain so we can align Laravel modules, React pages, and infrastructure work.

---

# 1. Core Platform & Tenancy

* **Organization lifecycle**
  * Org owners can create a new organization, edit its name, domain, and plan tier.
  * Each user must belong to at least one organization and can switch between organizations from the UI.
  * An organization exposes a feature manifest so the UI can hide/show modules based on plan tier and flags.
* **User management**
  * Fortify handles registration/login/password reset with email verification.
  * Org owners/admins can invite members via email; invitees accept and set credentials.
  * Roles (`owner`, `admin`, `manager`, `agent`, `viewer`) map to permissions through `spatie/laravel-permission`.
  * Disabled users cannot authenticate or access API endpoints but remain in audit history.
* **Session & context**
  * Sanctum SPA tokens secure authenticated routes.
  * A middleware enforces scoping of every request (HTTP + queue jobs) to the active organization ID.

---

# 2. Whistleblowing Intake

* **Channel management**
  * Internal users create and manage intake channels with unique slugs, status, and settings (captcha, languages).
  * A channel publishes its public encryption key plus limited metadata to unauthenticated clients.
* **Public intake flow**
  * Public form loads channel metadata, generates or retrieves a symmetric key, encrypts payload + attachments with WebCrypto, and submits ciphertext.
  * Server validates payload size, attachment count/type, captcha, and rate limit before persisting the encrypted report.
  * Reporters receive a reference code and optional secure follow-up link (token-based) without exposing agent identities.
* **Encryption guarantees**
  * Only ciphertext and non-sensitive metadata are stored server-side (database + MinIO).
  * Attachments upload via pre-signed URLs; server never keeps plaintext copies.

---

# 3. Case Management & Collaboration

* **Case creation**
  * Each accepted report spawns a case record linked to the originating channel and organization.
  * Cases default to `new` status with optional auto-assignment rules (round robin, owner assignment).
* **Inbox experience**
  * Authenticated agents can filter cases by status, assignee, priority, tags, and due date.
  * Managers can assign/reassign cases and update priority/due dates with business rule validation.
* **Messaging**
  * Case threads support agent â†” reporter messages; content is encrypted client-side before POSTing.
  * Attachments are versioned, link to messages, and respect access roles when generating short-lived download URLs.
* **Timeline & audit**
  * Each case action (status change, assignment, message, attachment) generates a timeline event and audit log entry.

---

# 4. Security, Compliance, and Privacy

* **Audit trail**
  * Every mutating action writes to `audit_logs` with actor, entity, diff snapshot, IP, and user agent.
  * Audit entries are immutable and exportable per organization.
* **Access control**
  * Route middleware enforces role-based abilities (e.g., only managers can assign, only owners change billing data).
  * Public endpoints (`/public/*`) use dedicated throttles and captcha; internal APIs require Sanctum and `VerifyCsrfToken`.
* **Data handling**
  * Encrypted payloads never enter logs, analytics, or notifications.
  * Background jobs that touch encrypted data run in scoped queues with no plaintext access.
* **Compliance posture**
  * Provide configurable retention policies (default 18 months) and allow manual purge/export per organization.
  * Locales and translations exist for the intake flow; minimum: English + two EU languages.

---

# 5. Notifications & Reporting

* **Agent notifications**
  * Agents opt into email (and optional Slack/webhook) alerts for new assignments or unread reporter replies.
  * Notification payloads include metadata only (case ID, channel name, timestamps) and link back to the case.
* **Reporter acknowledgements**
  * Reporter gets a confirmation screen with reference code and optional email receipt if provided.
  * Reminder emails for reporters use secure tokens without revealing agent information.
* **Org-level insights**
  * Dashboard cards show counts by status, SLA breaches, and open assignments (metadata only).
  * Export endpoints return CSV/JSON summaries stripped of encrypted content.

---

# 6. Feature Flags & Plans

* **Plan enforcement**
  * Each organization has a `plan_tier` plus feature flags describing enabled modules.
  * UI and API both block access to modules not included in plan; responses include upgrade hints.
* **Flag operations**
  * Owners can view active flags; internal admin tools allow toggling features per org for support/trials.
  * Expired or disabled flags revoke access in real time (middleware + policy checks).

---

# 7. Operations & Observability

* **Jobs and scheduling**
  * Queue workers process notifications, cleanup tasks, and scheduled digests using Horizon (or queue:work).
  * Scheduler runs hourly/daily jobs for SLA reminders, retention purges, and health checks.
* **Backups & recovery**
  * Daily `pg_dump` to MinIO with retention policy; integrity verified weekly.
  * Object storage lifecycle rules replicate or expire attachments per retention settings.
* **Monitoring**
  * Health endpoint exposes app/queue/database status for Uptime Kuma.
  * Structured logs include request IDs and organization IDs; sensitive fields masked.

---

# 8. Front-End Experience

* **SPA flow**
  * Inertia React renders authenticated dashboards; public intake form can run without authentication.
  * Global state stores org context, feature manifest, and encryption keys.
  * Tailwind v4 + shadcn components provide consistent UI; dark mode optional but not required for MVP.
* **Accessibility & UX**
  * Forms meet WCAG AA basics: labels, focus states, keyboard navigation.
  * Reporter flow supports autosave (localStorage) for long submissions without leaking plaintext to the server.

---

# 9. Open Questions

1. Do we enforce hard multi-tenancy (separate databases) or soft tenancy with org_id scoping for now?
2. Which captcha provider (Turnstile, hCaptcha, ReCAPTCHA) should we integrate for public intake?
3. What SLA targets (response time, resolution time) do we need to support in dashboards/notifications?
4. Should reporter follow-up links expire, and if so, after how many days without activity?
5. Are there regulatory standards (ISO 27001, GDPR Art. 33 notifications) we must surface explicitly in the product roadmap?

